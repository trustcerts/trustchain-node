# Monitoring

Nodes from layer one and layer two are publishing metrics that can be monitored by prometheus and then interpreted in
grafana.

## Prometheus
To add prometheus to a node service you have to append the yml file `prometheus/docker-compose.yml` to the bash script.
```
  -f $NODE_PATH/prometheus/docker-compose.yml \
```

Prometheus will monitor all services that are defined in the configuration file in `nodes/prometheus/prometheus.yml`.

### Exposing
You can expose the prometheus service by port or by hostname. You don't have to expose the service if you also run
grafana as a node service.

**Exposing by port**
- append the yml import in the script:
```
  -f $NODE_PATH/prometheus/docker-compose.yml \
  -f $NODE_PATH/prometheus/docker-compose.proxy.yml \
```
- define `PROMETHEUS_PORT` in your `.env` file if the port should have another value than `3003`

**Exposing by hostname**
- append the yml import in the script:
```
  -f $NODE_PATH/prometheus/docker-compose.yml \
  -f $NODE_PATH/prometheus/docker-compose.proxy.yml \
```
- define `PROMETHEUS_HOSTNAME` in your `.env` file if the hostname should have another value than `prometheus`

### Securing prometheus
There are different ways to protect the prometheus endpoint like basic auth or firewalls that can be configured. Please
check the official documentation if you expose the service and want to limit the access to it.

## Loki
To add loki to a node service you have to append the yml file `loki/docker-compose.yml`to the bash script.
```
  -f $NODE_PATH/loki/docker-compose.yml \
```

Loki will store all logs that are generated by the microservices to persist them. Logs can be viewed in different grafana boards.

Instead of using a local Loki serivce, you can also send the logs to an external one. The endpooint has to be set in the `LOKI_URL`. In this case the exposing step is irrelevant.

### Exposing
You can expose the loki service by port or by hostname. You don't have to expose the service if you also run
grafana as a node service.

**Exposing by port**
- append the yml import in the script:
```
  -f $NODE_PATH/loki/docker-compose.yml \
  -f $NODE_PATH/loki/docker-compose.proxy.yml \
```
- define `LOKI_PORT` in your `.env` file if the port should have another value than `3004`.

**Exposing by hostname**
- append the yml import in the script:
```
  -f $NODE_PATH/loki/docker-compose.yml \
  -f $NODE_PATH/loki/docker-compose.proxy.yml \
```
- define `LOKI_HOSTNAME` in your `.env` file if the hostname should have another value than `loki`.

### Securing loki
There are different ways to protect the loki endpoint like basic auth or firewalls that can be configured. Please
check the official documentation if you expose the service and want to limit the access to it.

## Grafana
To visualise the metrics or defining alerts grafana can be added to the system by appending the yml file `grafana/doocker-compoye.yml`.
A fresh installed grafana is used with the default credentials `admin/admin`.

### Exposing
The grafana endpoint can be exposed by port or by hostname.

**Exposing by port**
- append the yml import in the script:
```
  -f $NODE_PATH/grafana/docker-compose.yml \
  -f $NODE_PATH/grafana/docker-compose.proxy.yml \
```
- define `GRAFANA_PORT` in your `.env` file if the port should have another value than `3005`.

**Exposing by hostname**
- append the yml import in the script:
```
  -f $NODE_PATH/grafana/docker-compose.yml \
  -f $NODE_PATH/grafana/docker-compose.proxy.yml \
```
- define `GRAFANA_HOSTNAME` in your `.env` file if the hostname should have another value than `grafana`.

## Database
You can also add the parsed database to grafana to get more information.

### Exposing
**Exposing by port**
- append the yml import in the script:
```  
  -f $NODE_PATH/database/docker-compose.port.yml \
```

### Securing database
By exposing your database to the public make sure grafana has a read only user.
